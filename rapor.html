<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Rapor SD PSI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: 'Times New Roman', serif; margin: 40px; font-size: 14px; color: #000; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 12px; }
    th, td { border: 1px solid #000; padding: 8px 6px; vertical-align: top; line-height: 1.18; }
    .no-border td, .no-border th { border: none; padding: 4px; }

    /* compact */
    table.compact th, table.compact td { padding: 2px 4px; line-height: 1; }
    table.compact.extra th, table.compact.extra td { padding: 2px 4px; line-height: 1.05; }

    .center { text-align: center; }
    .section-title { font-weight: bold; margin: 8px 0 4px 0; text-align: left; }
    .section-title-center { font-weight: bold; margin: 8px 0 4px 0; text-align: center; }
    .footer { margin-top: 40px; }
    .ttd-row { display: flex; justify-content: space-between; margin-bottom: 40px; }
    .ttd { width: 45%; text-align: center; }
    .ttd-bottom { text-align: center; margin-top: 40px; }
    .col-no { width: 5%; text-align: center; }
    .col-mapel { width:25%; text-align: justify; }
    .col-nilai { width: 8%; text-align: center; }
    .col-capai { width: 70%; text-align: justify; text-justify: inter-word; }
    .half-table { width: 50%; }
    .text-center { text-align: center; }
    h3.center { margin: 6px 0 12px 0; }

    @media print {
      @page { size: legal portrait; margin: 15mm; }
      body { margin: 0; font-size: 12pt; }
      .no-print { display: none !important; }
      table.compact th, table.compact td { padding: 3px 6px; line-height: 1.05; }
    }

    .print-btn {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 1200;
      background: #007bff;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .print-btn:hover { opacity: 0.9; }
  </style>
</head>
<body>
<div id="pdf-content">
<!-- Identitas Siswa (compact, no-border for layout) -->
  <table class="no-border compact">
    <tr>
      <td>Nama Peserta Didik</td><td>: <span id="nama_siswa"></span></td>
      <td>Kelas</td><td>: <span id="kelas"></span></td>
    </tr>
    <tr>
      <td>NISN/ NIS</td><td>: <span id="nisn"></span> / <span id="nis"></span></td>
      <td>Fase</td><td>: <span id="fase"></span></td>
    </tr>
    <tr>
      <td>Nama Sekolah</td><td>: SD PSI FATHIR ALFATH</td>
      <td>Semester</td><td>: <span id="semester"></span></td>
    </tr>
    <tr>
      <td>Alamat</td><td>: Jl. Lintas Barat Sumatera Gedung Sako II Kec. Kaur Selatan Kab. Kaur</td>
      <td>Tahun Ajaran</td><td>: <span id="tahun_ajaran"></span></td>
    </tr>
  </table>

  <h3 class="center">LAPORAN HASIL BELAJAR SUMATIF AKHIR SEMESTER</h3>

  <!-- Kelompok A -->
  <div class="section-title">Kelompok A</div>
  <table class="compact">
    <tr>
      <th class="col-no">No.</th><th class="col-mapel">Mata Pelajaran</th>
      <th class="col-nilai">Nilai Akhir</th><th class="col-capai">Capaian Kompetensi</th>
    </tr>
    <tr><td class="col-no">1</td><td>Pendidikan Agama Islam dan Budi Pekerti</td><td id="nilai_pai" class="text-center col-nilai"></td><td id="deskripsi_pai" class="col-capai"></td></tr>
    <tr><td class="col-no">2</td><td>Pancasila</td><td id="nilai_pkn" class="text-center col-nilai"></td><td id="deskripsi_pkn" class="col-capai"></td></tr>
    <tr><td class="col-no">3</td><td>Bahasa Inggris</td><td id="nilai_bing" class="text-center col-nilai"></td><td id="deskripsi_bing" class="col-capai"></td></tr>
    <tr><td class="col-no">4</td><td>Ilmu Pengetahuan Alam dan Sosial</td><td id="nilai_ipas" class="text-center col-nilai"></td><td id="deskripsi_ipas" class="col-capai"></td></tr>
    <tr><td class="col-no">5</td><td>Matematika</td><td id="nilai_mtk" class="text-center col-nilai"></td><td id="deskripsi_mtk" class="col-capai"></td></tr>
    <tr><td class="col-no">6</td><td>Bahasa Arab</td><td id="nilai_barab" class="text-center col-nilai"></td><td id="deskripsi_barab" class="col-capai"></td></tr>
    <tr><td class="col-no">7</td><td>Pendidikan Jasmani, Olahraga, dan Kesehatan</td><td id="nilai_pjok" class="text-center col-nilai"></td><td id="deskripsi_pjok" class="col-capai"></td></tr>
    <tr><td class="col-no">8</td><td>Bahasa Indonesia</td><td id="nilai_bindo" class="text-center col-nilai"></td><td id="deskripsi_bindo" class="col-capai"></td></tr>
    <tr><td class="col-no">9</td><td>TIK/Informatika</td><td id="nilai_tik" class="text-center col-nilai"></td><td id="deskripsi_tik" class="col-capai"></td></tr>
  </table>

  <!-- Kelompok B -->
  <div class="section-title">Kelompok B</div>
  <table class="compact">
    <tr>
      <th class="col-no">No.</th><th class="col-mapel">Mata Pelajaran</th>
      <th class="col-nilai">Nilai Akhir</th><th class="col-capai">Capaian Kompetensi</th>
    </tr>
    <tr><td class="col-no">1</td><td>Adab, Hadits dan Do'a (AHD)</td><td id="nilai_ahd" class="text-center col-nilai"></td><td id="deskripsi_ahd" class="col-capai"></td></tr>
    <tr><td class="col-no">2</td><td>T2Q</td><td id="nilai_t2q" class="text-center col-nilai"></td><td id="deskripsi_t2q" class="col-capai"></td></tr>
    <tr><td class="col-no">3</td><td>Sirah</td><td id="nilai_sirah" class="text-center col-nilai"></td><td id="deskripsi_sirah" class="col-capai"></td></tr>
  </table>

  <!-- Ekstrakurikuler -->
  <table class="compact">
    <tr>
      <th class="col-no">No.</th><th class="col-mapel">Ekstrakurikuler</th>
      <th class="col-nilai">Predikat</th><th class="col-capai">Keterangan</th>
    </tr>
    <tr><td>1</td><td id="ekskul1"></td><td id="predikat1" class="text-center"></td><td id="ket1" class="text-center"></td></tr>
    <tr><td>2</td><td id="ekskul2"></td><td id="predikat2" class="text-center"></td><td id="ket2" class="text-center"></td></tr>
    <tr><td>3</td><td id="ekskul3"></td><td id="predikat3" class="text-center"></td><td id="ket3" class="text-center"></td></tr>
  </table>

  <!-- Catatan Guru -->
  <div class="section-title-center">Catatan Guru</div>
  <table class="compact">
    <tr><td class="text-center" id="catatan_guru"></td></tr>
  </table>

  <!-- Ketidakhadiran -->
  <div class="section-title">Ketidakhadiran</div>
  <table class="compact half-table">
    <tr><td>Sakit</td><td>: <span id="sakit"></span> Hari</td></tr>
    <tr><td>Izin</td><td>: <span id="izin"></span> Hari</td></tr>
    <tr><td>Tanpa Keterangan</td><td>: <span id="alpa"></span> Hari</td></tr>
  </table>

  <!-- Tanda tangan -->
  <div class="footer">
    <div class="ttd-row">
      <div class="ttd">
        <p>Orang Tua/ Wali Peserta Didik</p><br><br><br>
        <p>................................</p>
      </div>
      <div class="ttd">
        <p>Kaur, <span id="tanggal"></span><br>Wali Kelas,</p><br><br><br>
        <p><b id="wali_kelas"></b></p>
      </div>
    </div>
    <div class="ttd-bottom">
      <p>Kepala Sekolah,</p><br><br><br>
      <p><b id="kepala_sekolah"></b></p>
    </div>
  </div>
</div>

<button class="print-btn no-print" onclick="window.print()">Cetak</button>

<!-- html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<script>
  function safeSet(id, val) {
    const el = document.getElementById(id); if (el) el.innerText = val || "";
  }
  function isiRapor(data) {
    safeSet("nama_siswa", data["Nama Peserta Didik"] || data["Nama"] || "");
    safeSet("kelas", data["Kelas"] || data["Kelas / Rombel"] || "");
    safeSet("nisn", data["NISN"] || "");
    safeSet("nis", data["NIS"] || "");
    safeSet("fase", data["Fase"] || "");
    safeSet("semester", data["Semester"] || "");
    safeSet("tahun_ajaran", data["Tahun Ajaran"] || "");

    safeSet("nilai_pai", data["Nilai PAI"] || data["PAI"] || "");
    safeSet("deskripsi_pai", data["Deskripsi PAI"] || data["Deskripsi PAI "] || "");
    safeSet("nilai_pkn", data["Nilai PKN"] || data["PKN"] || "");
    safeSet("deskripsi_pkn", data["Deskripsi PKN"] || "");
    safeSet("nilai_bing", data["Nilai B. Inggris"] || data["Nilai B Inggris"] || "");
    safeSet("deskripsi_bing", data["Deskripsi B. Inggris"] || "");
    safeSet("nilai_ipas", data["Nilai IPAS"] || data["IPAS"] || "");
    safeSet("deskripsi_ipas", data["Deskripsi IPAS"] || "");
    safeSet("nilai_mtk", data["Nilai MTK"] || data["Nilai MATEMATIKA"] || "");
    safeSet("deskripsi_mtk", data["Deskripsi MTK"] || data["Deskripsi MATEMATIKA"] || "");
    safeSet("nilai_barab", data["Nilai B. Arab"] || data["Nilai B. ARAB"] || "");
    safeSet("deskripsi_barab", data["Deskripsi B. Arab"] || data["Deskripsi B. ARAB"] || "");
    safeSet("nilai_pjok", data["Nilai PJOK"] || "");
    safeSet("deskripsi_pjok", data["Deskripsi PJOK"] || "");
    safeSet("nilai_bindo", data["Nilai B.INDO"] || data["Nilai B. INDO"] || data["B.INDO"] || "");
    safeSet("deskripsi_bindo", data["Deskripsi B.INDO"] || "");
    safeSet("nilai_tik", data["Nilai TIK"] || "");
    safeSet("deskripsi_tik", data["Deskripsi TIK"] || "");

    safeSet("nilai_ahd", data["Nilai AHD"] || data["AHD"] || "");
    safeSet("deskripsi_ahd", data["Deskripsi AHD"] || "");
    safeSet("nilai_t2q", data["Nilai T2Q"] || data["T2Q"] || "");
    safeSet("deskripsi_t2q", data["Deskripsi T2Q"] || "");
    safeSet("nilai_sirah", data["Nilai SIROH"] || data["SIROH"] || "");
    safeSet("deskripsi_sirah", data["Deskripsi SIROH"] || "");

    safeSet("ekskul1", data["Ekskul 1"] || data["Ekstrakurikuler 1"] || "");
    safeSet("predikat1", data["Predikat 1"] || "");
    safeSet("ket1", data["Keterangan 1"] || "");
    safeSet("ekskul2", data["Ekskul 2"] || "");
    safeSet("predikat2", data["Predikat 2"] || "");
    safeSet("ket2", data["Keterangan 2"] || "");
    safeSet("ekskul3", data["Ekskul 3"] || "");
    safeSet("predikat3", data["Predikat 3"] || "");
    safeSet("ket3", data["Keterangan 3"] || "");

    safeSet("catatan_guru", data["Catatan Guru"] || "");
    safeSet("sakit", data["S"] || data["Sakit"] || "0");
    safeSet("izin", data["I"] || data["Izin"] || "0");
    safeSet("alpa", data["A"] || data["Alpa"] || "0");
    safeSet("tanggal", data["Tanggal"] || data["Tanggal Cetak"] || "");
    safeSet("wali_kelas", data["Wali Kelas"] || "");
    safeSet("kepala_sekolah", data["Kepala Sekolah"] || "");
  }
 async function fitAndDownloadPdf() {
    const el = document.getElementById('pdf-content');
    const opt = {
      margin: [0.566, 1, 0.212, 1], // cm
      filename: (document.getElementById('nama_siswa')?.innerText || 'rapor')+'.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 4, useCORS: true },
      jsPDF: { unit: 'cm', format: [21.59, 33.02], orientation: 'portrait' }
    };
    await html2pdf().set(opt).from(el).save();
    try{window.close()}catch(e){}
  }

  window.onload = () => {
    const data = JSON.parse(localStorage.getItem("raporData")||"{}");
    isiRapor(data);

    if (window.location.search.includes("dl=1")) {
      setTimeout(fitAndDownloadPdf, 500);
    }
  };
</script>
</body>
</html>
